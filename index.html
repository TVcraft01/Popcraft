<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PopCraft ‚Äî Viewer + Pack Generator</title>
  <style>
    :root{ --bg:#0e0f12; --accent:#06c9d8; --card:#141619; }
    *{ box-sizing:border-box; }
    html,body{ margin:0; height:100%; background:#111; color:#e9eef1; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; }
    header{ height:100px; display:grid; place-items:center; background:linear-gradient(135deg,var(--accent) 50%,transparent 50%); }
    header img{ height:80px; object-fit:contain; }
    main{ display:flex; height:calc(100vh - 100px); }
    #viewer{ flex:1 1 0; background:#0b0c0e; min-width:320px; display:flex; align-items:center; justify-content:center; }
    #sidebar{ width:440px; background:var(--card); padding:16px; box-shadow:-6px 0 24px rgba(0,0,0,0.6); overflow-y:auto; }
    #status{ margin-bottom:12px; padding:8px 10px; border-radius:6px; background:rgba(0,0,0,.6); color:#aefaa0; font:13px/1.3 monospace }
    label, button, select, input{ display:block; margin:6px 0; padding:8px 10px; border-radius:8px; border:none; font-weight:700 }
    button, label{ cursor:pointer; background:#06c9d8; color:#041414; transition:transform .1s,background .3s; }
    button:hover{ transform:scale(1.03); background:#09f0ff; }
    select,input{ background:#222; color:#fff; }
    .small{ font-size:13px; color:#b9c2c7; margin-top:6px; }
    .row{ display:flex; gap:8px; align-items:center; }
    .muted{ color:#9aa4ab; font-size:13px; }
    hr{ opacity:.06; margin:10px 0; border:none; border-top:1px solid rgba(255,255,255,0.05); }

    /* --- Box Gallery --- */
    #boxGallery{ display:grid; grid-template-columns:repeat(auto-fill,minmax(90px,1fr)); gap:8px; margin-top:8px; }
    .box-thumb{ position:relative; border-radius:8px; overflow:hidden; cursor:pointer; transition:transform .2s, box-shadow .3s; }
    .box-thumb img{ width:100%; height:90px; object-fit:cover; display:block; }
    .box-thumb:hover{ transform:scale(1.05); box-shadow:0 0 12px rgba(6,201,216,0.5); }
    .box-thumb.selected{ outline:3px solid var(--accent); transform:scale(1.05); }
    .box-thumb::after{
      content:attr(data-name);
      position:absolute; bottom:0; left:0; right:0;
      background:rgba(0,0,0,0.6); color:#fff;
      font-size:11px; text-align:center; padding:2px 4px;
    }
  </style>

  <script async src="https://cdn.jsdelivr.net/npm/es-module-shims@1.10.0/dist/es-module-shims.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <script type="importmap">
    { "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }}
  </script>
</head>
<body>
  <header>
    <img src="popcraft_title.png" alt="PopCraft" onerror="this.style.display='none'">
  </header>

  <main>
    <div id="viewer"></div>

    <aside id="sidebar">
      <div id="status">‚è≥ Ready</div>

      <div class="small">Model (preview)</div>
      <select id="modelSelect"></select>
      <div class="row">
        <button id="reloadModel">Load</button>
        <button id="refreshIndex" title="Reload index.json">‚Üª</button>
      </div>

      <hr>

      <div class="small">Skin (preview)</div>
      <div class="row">
        <input id="username" placeholder="Minecraft username" style="flex:1">
        <button id="fetchSkin">Get</button>
      </div>
      <label style="background:#333; color:#fff; padding:8px; border-radius:8px; cursor:pointer">
        Upload skin
        <input id="fileInput" type="file" accept="image/png" style="display:none">
      </label>
      <div id="fileName" class="muted">No skin uploaded</div>

      <hr>

      <div class="small">Box texture</div>
      <div id="boxGallery">Loading box textures...</div>

      <hr>

      <div class="small">Target item</div>
      <select id="itemTarget"><option>Loading items‚Ä¶</option></select>

      <div class="small">Pop name (in-game)</div>
      <input id="popName" value="MyPop">

      <div class="row">
        <button id="importPack">üìÇ Import existing pack (zip)</button>
        <input id="packInput" type="file" accept=".zip" style="display:none">
      </div>

      <div class="row" style="margin-top:10px">
        <button id="genPack">‚ö° Generate & Download PopCraft.zip</button>
        <button id="previewPack" title="Show what will be written (debug)">Preview</button>
      </div>
    </aside>
  </main>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    const statusEl = document.getElementById('status');
    const modelSelect = document.getElementById('modelSelect');
    const reloadModel = document.getElementById('reloadModel');
    const refreshIndex = document.getElementById('refreshIndex');
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const boxGallery = document.getElementById('boxGallery');

    const viewer = document.getElementById('viewer');
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setSize(viewer.clientWidth, viewer.clientHeight);
    if('outputColorSpace' in renderer) renderer.outputColorSpace = THREE.SRGBColorSpace;
    else renderer.outputEncoding = THREE.sRGBEncoding;
    viewer.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x111217);
    const camera = new THREE.PerspectiveCamera(45, viewer.clientWidth/viewer.clientHeight, 0.1, 1000);
    camera.position.set(0,2,6);
    scene.add(new THREE.AmbientLight(0xffffff, .8));
    const dir = new THREE.DirectionalLight(0xffffff,1);
    dir.position.set(4,6,6); scene.add(dir);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.autoRotate = true;

    const loader = new GLTFLoader();
    const modelGroup = new THREE.Group(); scene.add(modelGroup);
    let currentModel = null;
    let currentBoxBlob = null;

    function setStatus(txt, color){ statusEl.textContent = txt; statusEl.style.color = color || ''; console.log(txt); }

    // Load model index
    async function loadIndex(){
      try{
        const res = await fetch('3D_display/index.json');
        const data = await res.json();
        modelSelect.innerHTML = '';
        data.forEach(name=>{
          const opt = document.createElement('option');
          opt.value = name; opt.textContent = name;
          modelSelect.appendChild(opt);
        });
        await loadModel(modelSelect.value);
        setStatus('‚úÖ Models loaded');
      }catch(e){
        setStatus('‚ö†Ô∏è Could not load 3D_display/index.json','#ff9b9b');
      }
    }

    // Load 3D model
    async function loadModel(id){
      if(!id) return;
      try{
        modelGroup.clear();
        const glb = await loader.loadAsync(`3D_display/${id}/${id}.glb`);
        currentModel = glb.scene;
        currentModel.scale.setScalar(3.5 / currentModel.scale.length());
        modelGroup.add(currentModel);
        setStatus(`Model ${id} loaded`);
      }catch(e){
        console.warn(e);
        setStatus('Model load error','#ff9b9b');
      }
    }

    reloadModel.addEventListener('click', ()=>loadModel(modelSelect.value));
    refreshIndex.addEventListener('click', loadIndex);

    // ========== BOX GALLERY ==========
    async function loadBoxGallery(){
      try{
        const res = await fetch('box_color/index.json');
        if(!res.ok) throw new Error('missing');
        const data = await res.json();
        if(!Array.isArray(data.textures)){ boxGallery.textContent='No textures'; return; }

        boxGallery.innerHTML='';
        data.textures.forEach(async name=>{
          const div=document.createElement('div');
          div.className='box-thumb';
          div.dataset.name=name;
          const img=document.createElement('img');
          img.src=`box_color/${name}`;
          div.appendChild(img);
          div.onclick=async()=>{
            document.querySelectorAll('.box-thumb').forEach(e=>e.classList.remove('selected'));
            div.classList.add('selected');
            const r=await fetch(`box_color/${name}`);
            currentBoxBlob=await r.blob();
            setStatus(`Box selected: ${name}`);
          };
          boxGallery.appendChild(div);
        });
      }catch(e){
        console.warn(e);
        boxGallery.textContent='‚ö†Ô∏è Failed to load box_color/index.json';
      }
    }

    // Basic render loop
    (function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); })();

    loadIndex();
    loadBoxGallery();
  </script>
</body>
</html>
