<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PopCraft ‚Äî Viewer + Pack Generator</title>
  <style>
    :root{ --bg:#0e0f12; --accent:#06c9d8; }
    *{ box-sizing:border-box; }
    html,body{ margin:0; height:100%; background:#111; color:#e9eef1; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; }
    header{ height:100px; display:grid; place-items:center; background:linear-gradient(135deg,var(--accent) 50%,transparent 50%); }
    header img{ height:80px; object-fit:contain; }
    main{ display:flex; height:calc(100vh - 100px); }
    #viewer{ flex:1 1 0; background:#0b0c0e; min-width:320px; display:flex; align-items:center; justify-content:center; }
    #sidebar{ width:420px; background:#141619; padding:14px; box-shadow:-6px 0 24px rgba(0,0,0,0.6); overflow-y:auto; }
    #status{ margin-bottom:12px; padding:8px 10px; border-radius:6px; background:rgba(0,0,0,.6); color:#aefaa0; font:13px/1.3 monospace }
    label, button, select, input{ display:block; margin:6px 0; padding:8px 10px; border-radius:8px; border:none; font-weight:700 }
    button, label{ cursor:pointer; background:#06c9d8; color:#041414; }
    select,input{ background:#222; color:#fff; }
    .small{ font-size:13px; color:#b9c2c7; margin-top:6px; }
    .row{ display:flex; gap:8px; align-items:center; }
    .muted{ color:#9aa4ab; font-size:13px; }
    hr{ border:none; border-top:1px solid rgba(255,255,255,0.05); margin:10px 0; }
    #boxGallery{ display:grid; grid-template-columns:repeat(auto-fill,minmax(64px,1fr)); gap:6px; margin-top:8px; }
    .box-option{ border:2px solid transparent; border-radius:8px; overflow:hidden; cursor:pointer; transition:transform .15s,border .15s; }
    .box-option:hover{ transform:scale(1.05); border-color:var(--accent); }
    .box-option.active{ border-color:#00ffff; box-shadow:0 0 10px #00ffff60; }
    .box-option img{ width:100%; height:100%; object-fit:cover; display:block; }
  </style>

  <!-- libs -->
  <script async src="https://cdn.jsdelivr.net/npm/es-module-shims@1.10.0/dist/es-module-shims.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- three importmap for 3D preview -->
  <script type="importmap">
    { "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }}
  </script>
</head>
<body>
  <header>
    <img src="popcraft_title.png" alt="PopCraft" onerror="this.style.display='none'">
  </header>

  <main>
    <div id="viewer" aria-hidden="true"></div>

    <aside id="sidebar">
      <div id="status">‚è≥ Ready</div>

      <div class="small">Model (preview)</div>
      <select id="modelSelect"></select>
      <div class="row">
        <button id="reloadModel">Load</button>
        <button id="refreshIndex" title="Reload index.json">‚Üª</button>
      </div>

      <hr>

      <div class="small">Skin (preview)</div>
      <div class="row">
        <input id="username" placeholder="Minecraft username" style="flex:1">
        <button id="fetchSkin">Get</button>
      </div>
      <label>
        Upload skin
        <input id="fileInput" type="file" accept="image/png" style="display:none">
      </label>
      <div id="fileName" class="muted">No skin uploaded</div>

      <hr>

      <div class="small">Box texture</div>
      <label>
        Upload box texture
        <input id="boxInput" type="file" accept="image/png" style="display:none">
      </label>
      <div id="boxName" class="muted">Using model default (if any)</div>

      <div class="small" style="margin-top:8px">Or choose from gallery</div>
      <div id="boxGallery"></div>

      <hr>

      <div class="small">Target item</div>
      <select id="itemTarget"><option>Loading items‚Ä¶</option></select>

      <div class="small">Pop name (in-game)</div>
      <input id="popName" value="MyPop">

      <div class="row">
        <button id="importPack">üìÇ Import existing pack (zip)</button>
        <input id="packInput" type="file" accept=".zip" style="display:none">
      </div>

      <div class="row" style="margin-top:10px">
        <button id="genPack">‚ö° Generate & Download PopCraft.zip</button>
        <button id="previewPack" title="Show what will be written (debug)">Preview</button>
      </div>
    </aside>
  </main>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    const statusEl = document.getElementById('status');
    const viewer = document.getElementById('viewer');
    const modelSelect = document.getElementById('modelSelect');
    const reloadModel = document.getElementById('reloadModel');
    const refreshIndex = document.getElementById('refreshIndex');
    const usernameEl = document.getElementById('username');
    const fetchSkinBtn = document.getElementById('fetchSkin');
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const boxInput = document.getElementById('boxInput');
    const boxName = document.getElementById('boxName');
    const boxGallery = document.getElementById('boxGallery');
    const itemTarget = document.getElementById('itemTarget');
    const popNameEl = document.getElementById('popName');
    const importPackBtn = document.getElementById('importPack');
    const packInput = document.getElementById('packInput');
    const genPackBtn = document.getElementById('genPack');
    const previewPackBtn = document.getElementById('previewPack');

    let currentModelId = null;
    let currentSkinBlob = null;
    let currentBoxBlob = null;
    let importedZip = null;

    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setSize(Math.max(320, viewer.clientWidth), Math.max(240, viewer.clientHeight));
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    viewer.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x111217);
    const camera = new THREE.PerspectiveCamera(45, viewer.clientWidth/viewer.clientHeight, 0.1, 1000);
    camera.position.set(0,2,6);
    scene.add(new THREE.AmbientLight(0xffffff, .85));
    scene.add(new THREE.HemisphereLight(0xbfd7ff, 0x0a0a0a, 0.6));
    const dir = new THREE.DirectionalLight(0xffffff,1);
    dir.position.set(4,6,6);
    scene.add(dir);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.autoRotate = true;
    const loader = new GLTFLoader();
    const modelGroup = new THREE.Group();
    scene.add(modelGroup);

    function setStatus(t, c){ statusEl.textContent=t; statusEl.style.color=c||''; }

    async function loadBoxGallery(){
      try{
        const res = await fetch('box_color/index.json');
        const list = await res.json();
        boxGallery.innerHTML = '';
        list.forEach(name=>{
          const div=document.createElement('div');
          div.className='box-option';
          const img=document.createElement('img');
          img.src='box_color/'+name;
          div.appendChild(img);
          div.onclick=async()=>{
            document.querySelectorAll('.box-option').forEach(d=>d.classList.remove('active'));
            div.classList.add('active');
            const blob=await (await fetch('box_color/'+name)).blob();
            currentBoxBlob=blob;
            boxName.textContent=name+' (from gallery)';
            setStatus('‚úÖ Box selected');
          };
          boxGallery.appendChild(div);
        });
      }catch(e){ boxGallery.innerHTML='<div class="muted">No gallery</div>'; }
    }

    async function loadIndex(){
      try{
        const r=await fetch('3D_display/index.json');
        const list=await r.json();
        modelSelect.innerHTML='';
        list.forEach(x=>{
          const o=document.createElement('option');
          o.value=x;o.textContent=x;
          modelSelect.appendChild(o);
        });
        if(list.length) loadModel(list[0]);
      }catch(e){ modelSelect.innerHTML='<option>No models</option>'; }
    }

    async function loadModel(id){
      currentModelId=id;
      modelGroup.clear();
      try{
        const gltf=await loader.loadAsync(`3D_display/${id}/${id}.glb`);
        const node=gltf.scene;
        const box=new THREE.Box3().setFromObject(node);
        const size=new THREE.Vector3();box.getSize(size);
        const s=3.2/(Math.max(size.x,size.y,size.z)||1);
        node.scale.setScalar(s);
        const c=new THREE.Vector3();box.getCenter(c);node.position.sub(c);
        modelGroup.add(node);
        setStatus('Model loaded: '+id);
      }catch(e){ setStatus('‚ùå Model error','#f88'); }
    }

    async function loadItemsList(){
      try{
        const res=await fetch('https://raw.githubusercontent.com/PrismarineJS/minecraft-data/master/data/pc/1.21/items.json');
        const data=await res.json();
        itemTarget.innerHTML='';
        data.forEach(it=>{
          const o=document.createElement('option');
          o.value=it.name;o.textContent=it.name;
          itemTarget.appendChild(o);
        });
      }catch(e){
        ['iron_nugget','stick','diamond'].forEach(n=>{
          const o=document.createElement('option');
          o.value=n;o.textContent=n;
          itemTarget.appendChild(o);
        });
      }
    }

    fileInput.onchange=e=>{
      const f=e.target.files[0];if(!f)return;
      currentSkinBlob=f;fileName.textContent=f.name;setStatus('‚úÖ Skin uploaded');
    };
    boxInput.onchange=e=>{
      const f=e.target.files[0];if(!f)return;
      currentBoxBlob=f;boxName.textContent=f.name;setStatus('‚úÖ Box uploaded');
    };
    fetchSkinBtn.onclick=async()=>{
      const name=usernameEl.value.trim();if(!name)return;
      setStatus('Fetching skin...');
      try{
        const res=await fetch('https://api.ashcon.app/mojang/v2/user/'+encodeURIComponent(name));
        const d=await res.json();const url=d.textures?.skin?.url;
        const blob=await (await fetch(url)).blob();
        currentSkinBlob=blob;fileName.textContent=name+'.png';
        setStatus('‚úÖ Skin loaded');
      }catch(e){setStatus('‚ùå Skin failed','#f88');}
    };

    reloadModel.onclick=()=>loadModel(modelSelect.value);
    refreshIndex.onclick=()=>loadIndex();

    (function anim(){requestAnimationFrame(anim);controls.update();renderer.render(scene,camera);})();
    window.onresize=()=>{const w=viewer.clientWidth,h=viewer.clientHeight;camera.aspect=w/h;camera.updateProjectionMatrix();renderer.setSize(w,h);};

    loadItemsList();
    loadIndex();
    loadBoxGallery();
  </script>
</body>
</html>
