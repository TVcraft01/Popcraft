<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PopCraft ‚Äî Viewer</title>
  <style>
    :root{ --bg:#0e0f12; --accent:#06c9d8; }
    *{ box-sizing:border-box; }
    html,body{ margin:0; height:100%; background:#111; color:#e9eef1;
      font-family:system-ui, -apple-system, "Segoe UI", Roboto, Inter, Arial; }
    header{ height:100px; display:grid; place-items:center;
      background:linear-gradient(135deg, var(--accent) 50%, transparent 50%); }
    header img{ height:80px; object-fit:contain; }
    main{ display:flex; height:calc(100vh - 100px); }
    #viewer{ flex:1; touch-action:none; }
    #sidebar{ width:280px; background:#181a1f; padding:12px; }
    #status{ margin-bottom:10px; padding:6px 10px; border-radius:6px;
      background:rgba(0,0,0,.7); color:#aefaa0; font:12px/1.2 monospace }
    #sidebar input[type="file"]{ display:none; }
    label, button{ display:inline-block; margin:6px 0; cursor:pointer; padding:6px 10px;
      border-radius:6px; background:#06c9d8; color:#041414; border:none; }
    #username{ width:100%; padding:6px; margin:6px 0; border-radius:6px; border:none; }
    .hint{ position:fixed; bottom:12px; left:12px; z-index:10; color:#9aa4ab;
      font-size:13px; background:rgba(0,0,0,0.35); padding:8px; border-radius:8px }
  </style>
  
  <script async src="https://cdn.jsdelivr.net/npm/es-module-shims@1.10.0/dist/es-module-shims.min.js"></script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <header>
    <img src="popcraft_title.png" alt="PopCraft" onerror="this.style.display='none'">
  </header>
  <main>
    <div id="viewer"></div>
    <div id="sidebar">
      <div id="status">‚è≥ Chargement‚Ä¶</div>
      <label for="fileInput">üìÇ Importer skin</label>
      <input type="file" id="fileInput" accept="image/png">
      <input type="text" id="username" placeholder="Pseudo Minecraft">
      <button id="fetchSkin">üîç Charger skin</button>
    </div>
  </main>
  <div class="hint">Clique / glisse pour tourner ‚Äî rel√¢chement remet la rotation auto</div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    const status = document.getElementById('status');
    const viewer = document.getElementById('viewer');
    const fileInput = document.getElementById('fileInput');
    const usernameEl = document.getElementById('username');
    const fetchSkinBtn = document.getElementById('fetchSkin');

    let figurineMeshes = [];

    // scene/camera/renderer
    let W = viewer.clientWidth, H = viewer.clientHeight;
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, W/H, 0.1, 1000);
    camera.position.set(0, 2, 6);

    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(W, H);
    viewer.appendChild(renderer.domElement);

    // lights
    scene.add(new THREE.AmbientLight(0xffffff, .8));
    const dir = new THREE.DirectionalLight(0xffffff, 1);
    dir.position.set(4,6,6);
    scene.add(dir);

    // controls
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.enablePan = false;
    controls.enableZoom = false; // d√©sactive zoom
    controls.autoRotate = true;  // rotation int√©gr√©e
    controls.autoRotateSpeed = 2;

    // fallback cube
    const cube = new THREE.Mesh(
      new THREE.BoxGeometry(2,2,2),
      new THREE.MeshStandardMaterial({ color:0x00ff00 })
    );
    scene.add(cube);

    // group
    const modelGroup = new THREE.Group();
    scene.add(modelGroup);

    // loader
    const loader = new GLTFLoader();
    const url = 'pop.glb' + (location.hostname.includes('github.io') ? `?v=${Date.now()}` : '');
    loader.load(url, (gltf) => {
      scene.remove(cube);
      const model = gltf.scene;
      modelGroup.add(model);

      // scale + center
      const bbox = new THREE.Box3().setFromObject(model);
      const size = new THREE.Vector3(); bbox.getSize(size);
      const maxDim = Math.max(size.x, size.y, size.z) || 1;
      model.scale.setScalar(3.2 / maxDim);
      const center = new THREE.Vector3(); bbox.getCenter(center);
      model.position.sub(center);

      const texLoader = new THREE.TextureLoader();
      // box
      texLoader.load("box_template_blank.png", (texture) => {
        texture.magFilter = THREE.NearestFilter;
        texture.minFilter = THREE.NearestFilter;
        texture.flipY = false;
        model.traverse((child)=>{
          if(child.isMesh && child.name.startsWith("box_")){
            child.material = new THREE.MeshStandardMaterial({ map: texture });
          }
          if(child.isMesh && child.name.startsWith("fig_")){
            figurineMeshes.push(child);
          }
        });
      });
      // default skin
      texLoader.load("skin.png", (skinTex)=> applySkinTexture(skinTex));
      status.textContent = "‚úÖ Mod√®le charg√©";
    });

    // apply skin
    function applySkinTexture(texture){
      texture.magFilter = THREE.NearestFilter;
      texture.minFilter = THREE.NearestFilter;
      texture.flipY = false;
      figurineMeshes.forEach(mesh=>{
        mesh.material = new THREE.MeshStandardMaterial({
          map: texture,
          transparent: true,
          alphaTest: 0.1,   // garder la couche en dessous visible
          side: THREE.FrontSide
        });
      });
    }

    // upload skin
    fileInput.addEventListener("change", (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const url = URL.createObjectURL(file);
      new THREE.TextureLoader().load(url, (texture)=>{
        applySkinTexture(texture);
        status.textContent = "‚úÖ Nouveau skin appliqu√©";
      });
    });

    // fetch skin
    fetchSkinBtn.addEventListener("click", ()=>{
      const name = usernameEl.value.trim();
      if(!name) return;
      const url = `https://crafatar.com/skins/${encodeURIComponent(name)}`;
      new THREE.TextureLoader().load(url, (texture)=>{
        applySkinTexture(texture);
        status.textContent = `‚úÖ Skin de ${name}`;
      }, undefined, ()=> status.textContent = `‚ùå Skin introuvable`);
    });

    // animation
    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      // correction douce X/Z ‚Üí retour droit
      modelGroup.rotation.x *= 0.92;
      modelGroup.rotation.z *= 0.92;
      renderer.render(scene, camera);
    }
    animate();

    // resize
    window.addEventListener('resize', ()=>{
      const w = viewer.clientWidth, h = viewer.clientHeight;
      camera.aspect = w/h; camera.updateProjectionMatrix();
      renderer.setSize(w,h);
    });
  </script>
</body>
</html>
