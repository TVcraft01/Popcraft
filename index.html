<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PopCraft ‚Äî Viewer + Pack Generator</title>
  <style>
    :root{ --bg:#0e0f12; --accent:#06c9d8; }
    *{ box-sizing:border-box; }
    html,body{ margin:0; height:100%; background:#111; color:#e9eef1; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; }
    header{ height:100px; display:grid; place-items:center; background:linear-gradient(135deg,var(--accent) 50%,transparent 50%); }
    header img{ height:80px; object-fit:contain; }
    main{ display:flex; height:calc(100vh - 100px); }
    #viewer{ flex:1 1 0; background:#0b0c0e; min-width:320px; display:flex; align-items:center; justify-content:flex-start; }
    #sidebar{ width:360px; background:#141619; padding:14px; box-shadow:-6px 0 24px rgba(0,0,0,0.6); overflow-y:auto; }
    #status{ margin-bottom:12px; padding:8px 10px; border-radius:6px; background:rgba(0,0,0,.6); color:#aefaa0; font:13px/1.3 monospace }
    label, button, select, input{ display:block; margin:6px 0; padding:8px 10px; border-radius:8px; border:none; font-weight:700 }
    button, label{ cursor:pointer; background:#06c9d8; color:#041414; }
    select,input{ background:#222; color:#fff; }
    .small{ font-size:13px; color:#b9c2c7; margin-top:6px; }
  </style>

  <script async src="https://cdn.jsdelivr.net/npm/es-module-shims@1.10.0/dist/es-module-shims.min.js"></script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
  <header>
    <img src="popcraft_title.png" alt="PopCraft" onerror="this.style.display='none'">
  </header>

  <main>
    <div id="viewer"></div>

    <aside id="sidebar">
      <div id="status">‚è≥ Chargement‚Ä¶</div>

      <div class="small">Choisir un mod√®le :</div>
      <select id="modelSelect"></select>
      <button id="reloadModel">‚Üª Charger</button>

      <div class="small">Skin :</div>
      <input id="username" placeholder="Pseudo Minecraft" />
      <button id="fetchSkin">üîç Chercher</button>
      <label for="fileInput">üìÇ Uploader skin</label>
      <input id="fileInput" type="file" accept="image/png" style="display:none">
      <label id="fileLabel" style="background:#333;color:#fff;">Aucun</label>

      <div class="small">Item cible (ex: minecraft:stick)</div>
      <input id="itemTarget" value="minecraft:stick">

      <div class="small">Nom de la Pop :</div>
      <input id="popName" value="MaPop">

      <button id="genPack">üì¶ G√©n√©rer Pack ZIP</button>

      <div id="meshListBox" class="small"></div>
    </aside>
  </main>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    const viewer = document.getElementById('viewer');
    const statusEl = document.getElementById('status');
    const modelSelect = document.getElementById('modelSelect');
    const reloadModelBtn = document.getElementById('reloadModel');
    const usernameEl = document.getElementById('username');
    const fetchSkinBtn = document.getElementById('fetchSkin');
    const fileInput = document.getElementById('fileInput');
    const fileLabel = document.getElementById('fileLabel');
    const genPackBtn = document.getElementById('genPack');
    const itemTargetEl = document.getElementById('itemTarget');
    const popNameEl = document.getElementById('popName');

    let currentModelId = null;
    let currentSkinBlob = null;
    let currentBoxBlob = null;

    // Three.js setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, viewer.clientWidth/viewer.clientHeight, 0.1, 1000);
    camera.position.set(0, 2, 6);
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setSize(viewer.clientWidth, viewer.clientHeight);
    viewer.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, .85));
    const dir = new THREE.DirectionalLight(0xffffff, 1.0);
    dir.position.set(4,6,6);
    scene.add(dir);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.enableZoom = false;
    controls.autoRotate = true;

    const loader = new GLTFLoader();
    let modelGroup = new THREE.Group();
    scene.add(modelGroup);

    // Load model list from index.json
    async function loadModelList() {
      try {
        const res = await fetch('3D_display/index.json');
        const list = await res.json();
        modelSelect.innerHTML = '';
        list.forEach(m=>{
          const opt=document.createElement('option');
          opt.value=m.id||m;
          opt.textContent=m.name||m.id||m;
          modelSelect.appendChild(opt);
        });
        if(list[0]) loadModel(modelSelect.value);
      } catch(e) {
        statusEl.textContent='‚ùå index.json introuvable';
      }
    }

    async function loadModel(id) {
      try {
        statusEl.textContent='‚è≥ Chargement mod√®le...';
        modelGroup.clear();
        const glbPath=`3D_display/${id}/${id}.glb`;
        const gltf=await loader.loadAsync(glbPath);
        modelGroup.add(gltf.scene);

        // Charger la box texture par d√©faut
        const boxPath=`3D_display/${id}/box_template_blank.png`;
        const res=await fetch(boxPath);
        if(res.ok) currentBoxBlob=await res.blob();

        currentModelId=id;
        statusEl.textContent=`‚úÖ Mod√®le ${id} charg√©`;
      } catch(e) {
        console.error(e);
        statusEl.textContent='‚ùå Erreur chargement mod√®le';
      }
    }

    reloadModelBtn.onclick=()=> loadModel(modelSelect.value);

    // Fetch skin via Ashcon
    fetchSkinBtn.onclick=async()=>{
      const name=usernameEl.value.trim();
      if(!name) return;
      statusEl.textContent='üîé R√©cup√©ration skin...';
      try{
        const res=await fetch('https://api.ashcon.app/mojang/v2/user/'+encodeURIComponent(name));
        const data=await res.json();
        const url=data.textures?.skin?.url;
        const blob=await (await fetch(url)).blob();
        currentSkinBlob=blob;
        fileLabel.textContent=name+'.png';
        statusEl.textContent=`‚úÖ Skin ${name} r√©cup√©r√©`;
      }catch(e){ statusEl.textContent='‚ùå Skin introuvable'; }
    };

    // Upload local skin
    fileInput.onchange=(e)=>{
      const f=e.target.files[0];
      if(!f) return;
      fileLabel.textContent=f.name;
      currentSkinBlob=f;
      statusEl.textContent='‚úÖ Skin upload√©';
    };

    fileLabel.onclick=()=> fileInput.click();

    // G√©n√©rer pack ZIP
    genPackBtn.onclick=async()=>{
      if(!currentModelId){ alert('Pas de mod√®le'); return; }
      if(!currentSkinBlob){ alert('Pas de skin'); return; }
      if(!currentBoxBlob){ alert('Pas de texture box'); return; }

      const zip=new JSZip();
      const popName=popNameEl.value.trim()||'pop';
      const id=popName.toLowerCase().replace(/[^a-z0-9_]/g,'_');
      const item=itemTargetEl.value.trim()||'minecraft:stick';
      const itemFile=`assets/minecraft/items/${item.replace(':','_')}.json`;

      // model JSON minimal
      const modelJson={
        "textures":{
          "1":`item/${id}/skin`,
          "2":`item/${id}/box_texture`
        }
      };

      // item override
      const override=[{
        "when":[popName,popName.toLowerCase(),`ipattern:${popName.toLowerCase()}`,`iregex:.${popName}.`],
        "model":{"type":"minecraft:model","model":`minecraft:block/pop/${id}`}
      }];

      // add files to zip
      zip.file(`assets/minecraft/models/block/pop/${id}.json`,JSON.stringify(modelJson,null,2));
      zip.file(itemFile,JSON.stringify(override,null,2));
      zip.file(`assets/minecraft/textures/item/${id}/skin.png`,currentSkinBlob);
      zip.file(`assets/minecraft/textures/item/${id}/box_texture.png`,currentBoxBlob);

      const blob=await zip.generateAsync({type:"blob"});
      saveAs(blob,`PopCraft_${id}.zip`);
      statusEl.textContent='üì¶ Pack g√©n√©r√© !';
    };

    function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); }
    animate();
    loadModelList();
  </script>
</body>
</html>
