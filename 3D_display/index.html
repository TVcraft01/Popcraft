<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PopCraft ‚Äî Viewer (multi mod√®les)</title>
  <style>
    :root{ --bg:#0e0f12; --accent:#06c9d8; }
    *{ box-sizing:border-box; }
    html,body{ margin:0; height:100%; background:#111; color:#e9eef1; font-family:system-ui, -apple-system, "Segoe UI", Roboto, Inter, Arial; }
    header{ height:100px; display:grid; place-items:center; background:linear-gradient(135deg, var(--accent) 50%, transparent 50%); }
    header img{ height:80px; object-fit:contain; }
    main{ display:flex; height:calc(100vh - 100px); gap:0; }
    #viewer{ flex:1 1 0; background:#0b0c0e; min-width:320px; }
    #sidebar{ width:340px; background:#141619; padding:14px; box-shadow:-6px 0 24px rgba(0,0,0,0.6); }
    #status{ margin-bottom:12px; padding:8px 10px; border-radius:6px; background:rgba(0,0,0,.6); color:#aefaa0; font:13px/1.3 monospace }
    label, button, select{ display:inline-block; margin:6px 4px 6px 0; cursor:pointer; padding:8px 10px; border-radius:8px; background:#06c9d8; color:#041414; border:none; font-weight:700 }
    select{ background:#222; color:#fff; }
    #username{ width:100%; padding:8px; margin:8px 0; border-radius:8px; border:none; }
    .hint{ color:#9aa4ab; font-size:13px; margin-top:10px; background:rgba(0,0,0,0.14); padding:8px; border-radius:8px }
    ul{ padding-left:16px; color:#c9d3d8; }
    .small{ font-size:13px; color:#b9c2c7 }
  </style>

  <!-- es-module-shims pour compatibilit√© importmap -->
  <script async src="https://cdn.jsdelivr.net/npm/es-module-shims@1.10.0/dist/es-module-shims.min.js"></script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <header>
    <img src="popcraft_title.png" alt="PopCraft" onerror="this.style.display='none'">
  </header>

  <main>
    <div id="viewer"></div>

    <aside id="sidebar">
      <div id="status">‚è≥ Chargement‚Ä¶</div>

      <!-- S√©lecteur de mod√®le -->
      <div id="modelSelectorBox" style="display:none; margin-bottom:12px">
        <div class="small">Choisir un mod√®le :</div>
        <select id="modelSelect"></select>
        <button id="reloadModel">‚Üª Charger</button>
      </div>

      <div>
        <label for="fileInput">üìÇ Uploader skin</label>
        <input id="fileInput" type="file" accept="image/png" style="display:none">
        <label id="fileLabel" style="background:#333;color:#fff;">Aucun</label>
      </div>

      <div style="margin-top:10px">
        <input id="username" placeholder="Pseudo Minecraft" />
        <button id="fetchSkin">üîç Chercher</button>
      </div>

      <div style="margin-top:12px">
        <button id="resetCam">‚ü≤ Reset vue</button>
        <button id="applyDetectedOverlay" title="Re-apply heuristic overlay">üîß Re-d√©tecter overlay</button>
      </div>

      <div class="hint" style="margin-top:14px">
        Si la transparence masque la couche inf√©rieure, clique sur <strong>Re-d√©tecter overlay</strong>.
      </div>

      <div style="margin-top:12px">
        <div class="small">Meshes d√©tect√©s (fig_)</div>
        <div id="meshListBox" style="max-height:220px; overflow:auto; margin-top:6px; background:rgba(255,255,255,0.02); padding:8px; border-radius:6px"></div>
      </div>
    </aside>
  </main>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    const viewer = document.getElementById('viewer');
    const statusEl = document.getElementById('status');
    const modelSelectorBox = document.getElementById('modelSelectorBox');
    const modelSelect = document.getElementById('modelSelect');
    const reloadModelBtn = document.getElementById('reloadModel');

    // three basics
    let W = viewer.clientWidth, H = viewer.clientHeight;
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, W/H, 0.1, 1000);
    camera.position.set(0, 2, 6);

    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(W, H);
    viewer.appendChild(renderer.domElement);

    // lights
    scene.add(new THREE.AmbientLight(0xffffff, .85));
    const dir = new THREE.DirectionalLight(0xffffff, 1.0);
    dir.position.set(4,6,6);
    scene.add(dir);

    // controls
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.enablePan = false;
    controls.enableZoom = false;
    controls.autoRotate = true;
    controls.autoRotateSpeed = 1.4;
    controls.minPolarAngle = 0.35;
    controls.maxPolarAngle = Math.PI - 0.35;

    const loader = new GLTFLoader();
    let currentModelPath = null;
    let modelGroup = new THREE.Group();
    scene.add(modelGroup);

    // charger liste index.json
    async function loadModelList(){
      try{
        const res = await fetch('index.json');
        if(!res.ok) throw new Error("index.json introuvable");
        const list = await res.json();
        if(!Array.isArray(list) || list.length === 0) throw new Error("Liste vide");
        if(list.length === 1){
          currentModelPath = list[0];
          loadModel(currentModelPath);
        } else {
          modelSelectorBox.style.display = 'block';
          modelSelect.innerHTML = '';
          list.forEach((p,i)=>{
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = p;
            modelSelect.appendChild(opt);
          });
          currentModelPath = list[0];
          loadModel(currentModelPath);
        }
      }catch(e){
        console.error(e);
        statusEl.textContent = "‚ùå Erreur chargement index.json";
      }
    }

    // charger un mod√®le
    function loadModel(path){
      statusEl.textContent = "‚è≥ Chargement mod√®le " + path;
      // vider l'ancien
      modelGroup.clear();

      loader.load(path+'/pop.glb', (gltf)=>{
        const model = gltf.scene;
        modelGroup.add(model);

        // scale & center
        const bbox = new THREE.Box3().setFromObject(model);
        const size = new THREE.Vector3(); bbox.getSize(size);
        const maxDim = Math.max(size.x, size.y, size.z) || 1;
        const scl = 3.2 / maxDim;
        model.scale.setScalar(scl);
        const center = new THREE.Vector3(); bbox.getCenter(center);
        model.position.sub(center);

        // texture box
        const texLoader = new THREE.TextureLoader();
        texLoader.load(path+'/box_template_blank.png',(tex)=>{
          tex.flipY = false;
          tex.encoding = THREE.sRGBEncoding;
          tex.magFilter = THREE.NearestFilter;
          tex.minFilter = THREE.NearestFilter;
          tex.generateMipmaps = false;
          model.traverse((c)=>{ if(c.isMesh && c.name.startsWith("box_")) c.material = new THREE.MeshStandardMaterial({ map: tex }); });
        });

        statusEl.textContent = "‚úÖ Mod√®le " + path + " charg√©";
      }, undefined, (err)=>{
        console.error(err);
        statusEl.textContent = "‚ùå Erreur chargement mod√®le " + path;
      });
    }

    reloadModelBtn.addEventListener('click', ()=>{
      if(modelSelect.value) loadModel(modelSelect.value);
    });

    // animation loop
    function renderLoop(){
      requestAnimationFrame(renderLoop);
      controls.update();
      renderer.render(scene, camera);
    }
    renderLoop();

    loadModelList();

  </script>
</body>
</html>